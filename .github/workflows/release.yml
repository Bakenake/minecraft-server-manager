name: Release

# Push a version tag (e.g. v1.0.0) to build + publish installers automatically.
# Users with existing installs will be notified and auto-updated via electron-updater.
#
# Workflow: bump version in package.json → git tag v1.x.x → git push --tags
#   → This runs → Builds Win/Mac/Linux → Publishes GitHub Release with installers
#   → electron-updater picks up latest.yml → users get notified

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

env:
  NODE_OPTIONS: --max_old_space_size=4096

jobs:
  release:
    name: Build & Publish (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            platform: win
          - os: ubuntu-latest
            platform: linux
          - os: macos-latest
            platform: mac

    steps:
      # ── Checkout ──────────────────────────────────────────
      - name: Checkout
        uses: actions/checkout@v4

      # ── Node.js ───────────────────────────────────────────
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: npm

      # ── Install ───────────────────────────────────────────
      - name: Install root dependencies
        run: npm ci

      - name: Install backend dependencies
        run: npm ci --workspace=backend

      - name: Install frontend dependencies
        run: npm ci --workspace=frontend

      # ── Build ─────────────────────────────────────────────
      - name: Build backend (TypeScript → JS)
        run: npx tsc --project tsconfig.json
        working-directory: backend

      - name: Build frontend (Vite)
        run: npx vite build
        working-directory: frontend

      # ── Rebuild native modules for Electron ───────────────
      - name: Rebuild native modules
        run: npx electron-rebuild -f -w better-sqlite3
        env:
          npm_config_build_from_source: true

      # ── Electron Builder — build + publish ────────────────
      - name: Build Electron app & publish
        run: npx electron-builder --config electron-builder.json --publish always
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Code signing (optional — set these in repo secrets):
          # CSC_LINK: ${{ secrets.CSC_LINK }}
          # CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
          # APPLE_ID: ${{ secrets.APPLE_ID }}
          # APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}

      # ── Upload artifacts as fallback ──────────────────────
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: craftos-${{ matrix.platform }}
          path: |
            release/*.exe
            release/*.dmg
            release/*.AppImage
            release/*.deb
            release/*.yml
            release/*.yaml
            release/*.blockmap
          retention-days: 30
          if-no-files-found: warn
